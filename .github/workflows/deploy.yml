name: Deploy via SSH (Jump Host) + Docker Compose

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

          # Private key from GitHub Secrets
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"

          # SSH config with ProxyJump
          cat > "$HOME/.ssh/config" <<EOF
          Host bastion
            HostName ${{ secrets.BASTION_HOST }}
            User ${{ secrets.BASTION_USER }}
            IdentityFile $HOME/.ssh/id_ed25519
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null

          Host target
            HostName ${{ secrets.TARGET_HOST }}
            User ${{ secrets.TARGET_USER }}
            IdentityFile $HOME/.ssh/id_ed25519
            ProxyJump bastion
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

          chmod 600 "$HOME/.ssh/config"

      - name: Upload project to target (rsync)
        shell: bash
        run: |
          set -euo pipefail
          # Синхронизируем всё в правильную папку /opt/demo-docker-deploy/
          rsync -az --delete \
            -e "ssh -F $HOME/.ssh/config" \
            ./ target:/opt/demo-docker-deploy/

      - name: Deploy on target (docker compose up)
        shell: bash
        run: |
          set -euo pipefail

          ssh -F "$HOME/.ssh/config" target <<'CMD'
            set -euo pipefail
            cd /opt/demo-docker-deploy

            # Перезапуск с пересборкой
            docker compose down || true
            docker compose up -d --build

            echo "✅ Статус контейнеров:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          CMD